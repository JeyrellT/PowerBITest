# üö® Plan de Correcci√≥n Cr√≠tica - Discrepancias de Datos

## üìã Problemas Identificados y Soluciones

### 1. **Sistema de Puntos - 200 puntos extras sin explicar**

#### Problema:
- **Mostrado:** 530 puntos totales
- **Esperado:** 330 puntos (165 √ó 2 quizzes)
- **Discrepancia:** +200 puntos

#### Causas Potenciales:
1. ‚úÖ **Puntos de logros duplicados** - Los logros se est√°n sumando m√∫ltiples veces
2. ‚úÖ **Bonificaciones contadas dos veces** - Las bonificaciones por velocidad/precisi√≥n se duplican
3. ‚úÖ **Inicializaci√≥n con puntos base** - El usuario nuevo recibe puntos iniciales que no deber√≠an estar

#### Soluci√≥n:
```javascript
// En updateProgressAfterQuiz - AUDITAR c√°lculo de puntos
let quizPoints = 0;

// 1. Puntos base SOLO por nivel y correctas
questionDetails.forEach(detail => {
  if (detail.correct) {
    const basePoints = detail.level === 'avanzado' ? 30 : 
                       detail.level === 'intermedio' ? 20 : 10;
    quizPoints += basePoints;
  }
});

// 2. Bonificaciones UNA SOLA VEZ
const scorePercentage = (correctAnswers / totalQuestions) * 100;
if (scorePercentage === 100 && totalQuestions >= 5) {
  quizPoints += 100; // Quiz perfecto
} else if (scorePercentage >= 90) {
  quizPoints += 50;
} else if (scorePercentage >= 80) {
  quizPoints += 25;
}

// 3. Bonus por velocidad SOLO si precisi√≥n >= 80%
const avgTimePerQuestion = totalTime / totalQuestions;
if (avgTimePerQuestion < 30000 && scorePercentage >= 80) {
  quizPoints += 50;
}

// 4. Logros SE SUMAN APARTE (no en el quiz)
// NO sumar aqu√≠, solo en unlockAchievement()

console.log('üí∞ Desglose de puntos:', {
  basePoints: questionDetails.filter(d => d.correct).length * 20,
  bonusPrecision: scorePercentage >= 90 ? 50 : scorePercentage >= 80 ? 25 : 0,
  bonusSpeed: avgTimePerQuestion < 30000 ? 50 : 0,
  total: quizPoints
});
```

---

### 2. **Conteo de Preguntas - 5 vs 10 preguntas**

#### Problema:
- **Perfil Overview:** "5 preguntas respondidas"
- **Precisi√≥n mostrada:** "8/10" (indica 10 preguntas)
- **Real:** 2 quizzes √ó 5 preguntas = 10 preguntas totales

#### Causa:
```javascript
// ‚ùå PROBLEMA: answeredQuestions solo guarda preguntas CORRECTAS
if (isCorrect) {
  saveAnsweredQuestion(question.id);
}

// Entonces: 4 correctas en quiz 1 + 4 correctas en quiz 2 = 8 en answeredQuestions
// Pero se mostraron 10 preguntas en total (5 + 5)
```

#### Soluci√≥n:
```javascript
// ‚úÖ SEPARAR dos conceptos:
// 1. answeredQuestions = preguntas respondidas (correctas o incorrectas)
// 2. masteredQuestions = preguntas dominadas (m√∫ltiples intentos correctos)

// En recordQuestionAttempt - guardar TODAS las preguntas respondidas
const recordQuestionAttempt = (questionId, isCorrect, timeSpent, metadata) => {
  // ... c√≥digo existente ...
  
  // ‚úÖ Agregar a answeredQuestions SIEMPRE (no solo si es correcta)
  if (!prev.answeredQuestions.includes(questionId)) {
    prev.answeredQuestions.push(questionId);
  }
  
  // Las incorrectas pueden volver al pool, pero YA FUERON RESPONDIDAS
};

// En getStats()
const questionsAnswered = progress.answeredQuestions.length; // TODAS las respondidas
const masteredQuestions = Object.values(progress.questionTracking)
  .filter(t => t.status === 'mastered').length; // Solo las dominadas
```

---

### 3. **Sistema de "Dominio" - Inconsistencia en definici√≥n**

#### Problema:
- **Tab Analysis:** "0 preguntas dominadas"
- **Tab Domains:** "2/12", "2/20" preguntas dominadas

#### Causa:
Hay confusi√≥n entre:
- **Dominadas** = status === 'mastered' (requiere m√∫ltiples intentos correctos)
- **Respondidas correctamente** = correctAttempts >= 1

#### Soluci√≥n:
```javascript
// ‚úÖ CLARIFICAR estados de preguntas
const QUESTION_STATUS = {
  NEW: 'new',           // Nunca vista
  LEARNING: 'learning', // 1-2 intentos correctos
  REVIEWING: 'reviewing', // 3+ intentos correctos
  MASTERED: 'mastered',  // 5+ intentos correctos consecutivos
  RETIRED: 'retired'     // Muy f√°cil, no mostrar m√°s
};

// En domainStats
domainStats[domain] = {
  attempted: 10,      // Total de preguntas intentadas
  correct: 8,         // Preguntas respondidas correctamente (al menos una vez)
  incorrect: 2,       // Preguntas con al menos un intento incorrecto
  mastered: 3,        // Preguntas con status === 'mastered'
  total: 100,         // Total de preguntas disponibles en este dominio
  accuracy: 80        // (correct / attempted) * 100
};

// En UI
<div>
  üìä {domain}
  <div>{stats.correct}/{stats.total} correctas</div>
  <div>üéì {stats.mastered} dominadas</div>
  <div>‚úÖ {stats.accuracy}% precisi√≥n</div>
</div>
```

---

### 4. **Registro de Intentos - 4 intentos en 2 preguntas**

#### Problema:
"Preparar Datos" muestra 4 intentos pero solo 2 preguntas (1‚úì 1‚úó)

#### Causa:
```javascript
// ‚ùå PROBLEMA: recordQuestionAttempt se llama M√öLTIPLES VECES
// ResultsScreen: 5 veces (una por pregunta)
// updateProgressAfterQuiz: 5 veces M√ÅS (duplicado)
// Total: 10 llamadas para 5 preguntas = DUPLICACI√ìN
```

#### Soluci√≥n:
‚úÖ **YA APLICADA:** Eliminar llamadas duplicadas en ResultsScreen
```javascript
// ResultsScreen.js - ANTES
results.questions.forEach(question => {
  recordQuestionAttempt(/* ... */); // ‚ùå Llamada duplicada
});
updateProgressAfterQuiz(/* ... */);

// ResultsScreen.js - DESPU√âS
// ‚úÖ Solo llamar updateProgressAfterQuiz
updateProgressAfterQuiz(/* ... */); // Internamente llama a recordQuestionAttempt
```

---

### 5. **Tiempo Promedio - Todos muestran "0.0s"**

#### Problema:
- **Dominios:** Todos muestran "0.0s" de tiempo promedio
- **Quiz real:** 22 segundos totales (4.4s promedio por pregunta)

#### Causa:
```javascript
// ‚ùå PROBLEMA: timeSpent no se est√° propagando correctamente
const questionDetails = results.questions.map((question, index) => ({
  id: question.id,
  domain: question.dominio,
  level: question.nivel,
  correct: results.answers[index] === question.respuestaCorrecta,
  timeSpent: results.timeElapsed / results.questions.length // ‚ö†Ô∏è Promedio, no real
}));
```

#### Soluci√≥n:
```javascript
// ‚úÖ OPCI√ìN 1: Capturar tiempo real por pregunta
// En QuizScreen - guardar timestamp de cada pregunta
const [questionTimestamps, setQuestionTimestamps] = useState({});

const handleAnswer = (answer) => {
  const endTime = Date.now();
  const startTime = questionTimestamps[currentQuestion];
  const timeSpent = endTime - startTime;
  
  // Guardar en results
  results.timesByQuestion[currentQuestion] = timeSpent;
};

// ‚úÖ OPCI√ìN 2: Usar promedio pero propagarlo correctamente
const avgTime = totalTime / totalQuestions;
questionDetails.forEach(detail => {
  recordQuestionAttempt(detail.id, detail.correct, avgTime, {
    domain: detail.domain,
    level: detail.level
  });
});

// En updateQuestionStatusAndConfidence
if (timeSpent > 0) {
  const totalTime = tracking.averageTimeSpent * (tracking.totalAttempts - 1);
  tracking.averageTimeSpent = (totalTime + timeSpent) / tracking.totalAttempts;
}

// En domainStats
domainStats[domain].timeSpent += timeSpent; // ‚úÖ Acumular
domainStats[domain].avgTime = 
  domainStats[domain].timeSpent / domainStats[domain].attempted; // ‚úÖ Recalcular
```

---

### 6. **Duplicaci√≥n en Actividad Reciente**

#### Problema:
- Muestra el mismo quiz dos veces con timestamps id√©nticos
- M√∫ltiples eventos `save_autosave_success`

#### Causa:
1. ‚úÖ **Doble procesamiento en ResultsScreen** - Ya corregido
2. ‚úÖ **Telemetry duplicado** - Ya corregido con `recentEvents` Set
3. ‚ö†Ô∏è **History duplicado** - Falta validaci√≥n

#### Soluci√≥n:
```javascript
// En updateProgressAfterQuiz
applyProgressUpdate((prev) => {
  // ‚úÖ VERIFICAR si ya existe este quiz en history
  const recentHistory = (prev.history || []).slice(0, 5);
  const isDuplicate = recentHistory.some(h => 
    h.type === 'quiz' && 
    h.questions === totalQuestions &&
    h.correctAnswers === correctAnswers &&
    Math.abs(new Date(h.completedAt) - Date.now()) < 2000 // < 2 segundos
  );

  if (isDuplicate) {
    console.warn('‚ö†Ô∏è Quiz duplicado detectado en historial, ignorando actualizaci√≥n');
    return prev; // ‚úÖ NO hacer cambios
  }
  
  // ... resto del c√≥digo ...
});
```

---

### 7. **XP vs Puntos - Dos m√©tricas sin explicaci√≥n**

#### Problema:
- **Log:** "Puntos ganados: 165 XP ganado: 135"
- No est√° clara la diferencia entre XP y puntos

#### Clarificaci√≥n:
```javascript
/**
 * SISTEMA DE PROGRESI√ìN:
 * 
 * 1. PUNTOS (totalPoints):
 *    - Moneda del juego
 *    - Se ganan por responder correctamente
 *    - Se usan para: ayudas, desbloquear contenido, ranking
 *    - F√≥rmula: basePoints + bonificaciones
 * 
 * 2. XP (totalXP):
 *    - Experiencia para nivel de usuario
 *    - Solo para c√°lculo de nivel (1-10)
 *    - No se gasta, solo se acumula
 *    - F√≥rmula: puntos √ó 1.5 (o factor configurable)
 * 
 * Ejemplo:
 * - Quiz: 4/5 correctas, nivel intermedio
 * - Puntos base: 4 √ó 20 = 80 pts
 * - Bonus precisi√≥n (80%): +25 pts
 * - Bonus velocidad: +50 pts
 * - Total puntos: 155 pts
 * - Total XP: 155 √ó 1.5 = 232 XP
 */

const quizXP = Math.round(quizPoints * 1.5);
console.log(`üí∞ Ganaste ${quizPoints} puntos (para gastar) y ${quizXP} XP (para nivel)`);
```

#### Soluci√≥n UI:
```javascript
// Mostrar ambos claramente
<div className="rewards">
  <div className="reward">
    <span className="icon">üí∞</span>
    <span className="label">Puntos</span>
    <span className="value">+{pointsEarned}</span>
    <span className="description">Para comprar ayudas</span>
  </div>
  <div className="reward">
    <span className="icon">‚≠ê</span>
    <span className="label">XP</span>
    <span className="value">+{xpEarned}</span>
    <span className="description">Para subir de nivel</span>
  </div>
</div>
```

---

### 8. **Porcentajes de Cobertura - Extremadamente bajos**

#### Problema:
- **Cobertura:** 2%-8% con 2 quizzes completados
- **Esperado:** Mucho mayor

#### Causa:
```javascript
// ‚ùå PROBLEMA: Denominador incorrecto
const total = 100; // Total de preguntas en el dataset
const attempted = 2; // Preguntas respondidas en este dominio
const coverage = (attempted / total) * 100; // 2%

// Pero si el dominio solo tiene 12 preguntas:
// coverage deber√≠a ser (2/12) * 100 = 16.7%
```

#### Soluci√≥n:
```javascript
// ‚úÖ Cargar el total REAL de preguntas por dominio
import { preguntas } from '../data/preguntas';

const getTotalQuestionsByDomain = (domain) => {
  return preguntas.filter(q => q.dominio === domain).length;
};

// En domainStats
domainStats[domain] = {
  attempted: 2,
  correct: 1,
  total: getTotalQuestionsByDomain(domain), // ‚úÖ Total REAL
  coverage: (2 / getTotalQuestionsByDomain(domain)) * 100 // ‚úÖ Cobertura correcta
};

// Ejemplo: "preparar-datos" tiene 20 preguntas
// 2 intentadas / 20 total = 10% de cobertura ‚úÖ
```

---

## üîß Orden de Implementaci√≥n

### Fase 1: Correcciones Cr√≠ticas (YA APLICADAS ‚úÖ)
1. ‚úÖ Eliminar duplicaci√≥n en ResultsScreen
2. ‚úÖ Prevenir doble inicializaci√≥n del contexto
3. ‚úÖ Agregar anti-duplicaci√≥n en telemetry
4. ‚úÖ Agregar validaciones en getStats()

### Fase 2: Correcciones de Datos (SIGUIENTE)
5. ‚ö†Ô∏è Corregir conteo de preguntas (answeredQuestions)
6. ‚ö†Ô∏è Corregir c√°lculo de puntos (auditor√≠a completa)
7. ‚ö†Ô∏è Agregar tiempo real por pregunta
8. ‚ö†Ô∏è Clarificar sistema de "dominio"

### Fase 3: Mejoras de UI (DESPU√âS)
9. ‚ö†Ô∏è Mostrar XP vs Puntos claramente
10. ‚ö†Ô∏è Corregir porcentajes de cobertura
11. ‚ö†Ô∏è Agregar tooltips explicativos

---

## üß™ Plan de Testing Post-Correcci√≥n

### Test 1: Verificar Puntos
```
1. Resetear datos (localStorage.clear())
2. Completar Quiz 1: 5 preguntas, 4 correctas (80%), nivel intermedio
3. Verificar puntos:
   - Base: 4 √ó 20 = 80 pts
   - Bonus 80%: +25 pts
   - Total esperado: 105 pts (sin bonus velocidad)
4. Completar Quiz 2: mismo resultado
5. Total esperado: 210 pts
```

### Test 2: Verificar Preguntas
```
1. Quiz 1: 5 preguntas (3 correctas, 2 incorrectas)
2. Verificar:
   - questionsAnswered: 5 ‚úÖ
   - correctAnswers: 3 ‚úÖ
   - answeredQuestions.length: 5 ‚úÖ (no 3)
3. Quiz 2: 5 preguntas m√°s (4 correctas, 1 incorrecta)
4. Verificar:
   - questionsAnswered: 10 ‚úÖ
   - correctAnswers: 7 ‚úÖ
```

### Test 3: Verificar No Duplicaci√≥n
```
1. Abrir DevTools Console
2. Completar un quiz
3. Verificar que en logs:
   - recordQuestionAttempt: 5 llamadas ‚úÖ
   - updateProgressAfterQuiz: 1 llamada ‚úÖ
   - NO aparezca "Quiz duplicado detectado" ‚úÖ
4. Verificar history:
   - Solo 1 entrada del quiz ‚úÖ
```

---

## üìä M√©tricas de √âxito

### Antes de Correcciones:
- ‚ùå Puntos: 530 (inflados)
- ‚ùå Preguntas: 5 (deber√≠a ser 10)
- ‚ùå Intentos: 4 en 2 preguntas (duplicado)
- ‚ùå Tiempo: 0.0s (no se propaga)
- ‚ùå History: 2 entradas id√©nticas

### Despu√©s de Correcciones:
- ‚úÖ Puntos: ~330 (2 quizzes √ó 165 pts)
- ‚úÖ Preguntas: 10 (todas las respondidas)
- ‚úÖ Intentos: 2 por dominio (sin duplicar)
- ‚úÖ Tiempo: 4.4s promedio
- ‚úÖ History: 2 entradas √∫nicas

